{"version":3,"file":"consumption.min.js","sources":["../src/consumption.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Consumption history table management.\n *\n * @module     aiprovider_datacurso/consumption\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable */\nimport Ajax from 'core/ajax';\nimport { get_string as getString } from 'core/str';\n\nexport const init = () => {\n\n    // üîí Evita doble inicializaci√≥n del m√≥dulo\n    if (window._consumptionInitialized) {\n        console.warn(\"‚ö†Ô∏è M√≥dulo de consumo ya inicializado ‚Äî se omite nueva carga.\");\n        return;\n    }\n    window._consumptionInitialized = true;\n\n    console.log(\"Historial de consumo inicializado ‚úÖ\");\n\n    // Elementos del DOM\n    const tableBody = document.getElementById('consumption-table-body');\n    const filterService = document.getElementById('filter-service');\n    const filterAction = document.getElementById('filter-action');\n    const filterFrom = document.getElementById('filter-date-from');\n    const filterTo = document.getElementById('filter-date-to');\n    const prevPageBtn = document.getElementById('prev-page');\n    const nextPageBtn = document.getElementById('next-page');\n    const pageInfo = document.getElementById('page-info');\n\n    // üìÑ Estado inicial\n    let currentPage = parseInt(sessionStorage.getItem('consumptionPage')) || 1;\n\n    const savePage = (page) => {\n        sessionStorage.setItem('consumptionPage', page);\n    };\n\n    /**\n     * üß© Cargar lista de servicios desde el WS\n     */\n    const loadServices = async () => {\n        try {\n            const response = await Ajax.call([{\n                methodname: 'aiprovider_datacurso_get_services',\n                args: {}\n            }])[0];\n\n            // Limpiar y agregar opci√≥n \"todos\"\n            filterService.innerHTML = '<option value=\"all\">Todos los servicios</option>';\n\n            if (response?.services?.length) {\n                response.services.forEach(s => {\n                    const opt = document.createElement('option');\n                    opt.value = s.id;\n                    opt.textContent = s.name;\n                    filterService.appendChild(opt);\n                });\n            } else {\n                console.warn(\"‚ö†Ô∏è No se encontraron servicios para mostrar.\");\n            }\n        } catch (error) {\n            console.error(\"‚ùå Error al cargar servicios:\", error);\n        }\n    };\n\n    /**\n     * üß© Cargar lista de acciones desde el WS\n     */\n    const loadActions = async () => {\n        try {\n            const response = await Ajax.call([{\n                methodname: 'aiprovider_datacurso_get_actions',\n                args: {}\n            }])[0];\n\n            // Limpiar y agregar opci√≥n \"todas\"\n            filterAction.innerHTML = '<option value=\"all\">Todas las acciones</option>';\n\n            if (response?.actions?.length) {\n                response.actions.forEach(a => {\n                    const opt = document.createElement('option');\n                    opt.value = a.id;\n                    opt.textContent = a.name;\n                    filterAction.appendChild(opt);\n                });\n            } else {\n                console.warn(\"‚ö†Ô∏è No se encontraron acciones para mostrar.\");\n            }\n        } catch (error) {\n            console.error(\"‚ùå Error al cargar acciones:\", error);\n        }\n    };\n\n    /**\n     * üßæ Renderizar tabla de consumos\n     */\n    const renderTable = (consumos) => {\n        tableBody.innerHTML = '';\n        if (!consumos || consumos.length === 0) {\n            getString('nodata', 'aiprovider_datacurso').then(nodata => {\n                tableBody.innerHTML = `<tr><td colspan=\"7\">${nodata}</td></tr>`;\n            });\n            pageInfo.textContent = '';\n            prevPageBtn.disabled = true;\n            nextPageBtn.disabled = true;\n            return;\n        }\n\n        consumos.forEach(item => {\n            const row = document.createElement('tr');\n            row.innerHTML = `\n                <td>${item.id_consumption}</td>\n                <td>${item.userid || '-'}</td>\n                <td>${item.action}</td>\n                <td>${item.id_service}</td>\n                <td>${item.cant_tokens}</td>\n                <td>${item.balance}</td>\n                <td>${item.date}</td>\n            `;\n            tableBody.appendChild(row);\n        });\n    };\n\n    /**\n     * üîç Obtener historial de consumo con filtros\n     */\n    const fetchData = () => {\n        const serviceValue = filterService.value;\n        const actionValue = filterAction.value;\n        const fromValue = filterFrom.value;\n        const toValue = filterTo.value;\n\n        const args = {\n            page: currentPage,\n            limit: 10,\n            servicio: serviceValue !== 'all' ? serviceValue : '',\n            accion: actionValue !== 'all' ? actionValue : '',\n            fecha_desde: fromValue || '',\n            fecha_hasta: toValue || ''\n        };\n\n        console.log(\"üì§ Enviando petici√≥n al WS con args:\", JSON.stringify(args));\n\n        Ajax.call([{\n            methodname: 'aiprovider_datacurso_get_consumption_history',\n            args: args\n        }])[0].then(response => {\n            console.log(\"üì• Respuesta del servidor:\", response);\n\n            const consumos = response?.consumption || [];\n            renderTable(consumos);\n\n            // üìë Paginaci√≥n\n            const pagination = response?.pagination;\n            if (pagination) {\n                const { current_page, total_pages, total } = pagination;\n                pageInfo.textContent = `P√°gina ${current_page} de ${total_pages} (${total} registros)`;\n                prevPageBtn.disabled = current_page <= 1;\n                nextPageBtn.disabled = current_page >= total_pages;\n            } else {\n                pageInfo.textContent = '';\n                prevPageBtn.disabled = true;\n                nextPageBtn.disabled = true;\n            }\n        }).catch(async (e) => {\n            const nodata = await getString('nodata', 'aiprovider_datacurso');\n            tableBody.innerHTML = `<tr><td colspan=\"7\">${nodata}</td></tr>`;\n            console.error(\"‚ùå Error al obtener historial de consumo:\", e);\n        });\n    };\n\n    // üéØ Filtros (reinician a p√°gina 1)\n    [filterService, filterAction, filterFrom, filterTo].forEach(el => {\n        el.addEventListener('change', () => {\n            currentPage = 1;\n            savePage(currentPage);\n            fetchData();\n        });\n    });\n\n    // ‚èÆ P√°gina anterior\n    prevPageBtn.addEventListener('click', () => {\n        if (currentPage > 1) {\n            currentPage--;\n            savePage(currentPage);\n            fetchData();\n        }\n    });\n\n    // ‚è≠ P√°gina siguiente\n    nextPageBtn.addEventListener('click', () => {\n        currentPage++;\n        savePage(currentPage);\n        fetchData();\n    });\n\n    // üöÄ Carga inicial (servicios + acciones + datos)\n    Promise.all([loadServices(), loadActions()])\n        .then(() => {\n            fetchData();\n        })\n        .catch(e => {\n            console.error(\"‚ùå Error durante carga inicial:\", e);\n        });\n};\n"],"names":["window","_consumptionInitialized","console","warn","log","tableBody","document","getElementById","filterService","filterAction","filterFrom","filterTo","prevPageBtn","nextPageBtn","pageInfo","currentPage","parseInt","sessionStorage","getItem","savePage","page","setItem","fetchData","serviceValue","value","actionValue","fromValue","toValue","args","limit","servicio","accion","fecha_desde","fecha_hasta","JSON","stringify","call","methodname","then","response","consumos","innerHTML","length","nodata","textContent","disabled","forEach","item","row","createElement","id_consumption","userid","action","id_service","cant_tokens","balance","date","appendChild","renderTable","consumption","pagination","current_page","total_pages","total","catch","async","error","e","el","addEventListener","Promise","all","Ajax","services","_response$services","s","opt","id","name","loadServices","actions","_response$actions","a","loadActions"],"mappings":"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"}