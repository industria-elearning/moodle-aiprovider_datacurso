{"version":3,"file":"consumption.min.js","sources":["../src/consumption.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Consumption history table management.\n *\n * @module     aiprovider_datacurso/consumption\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable */\nimport Ajax from 'core/ajax';\nimport { get_string as getString } from 'core/str';\n\nexport const init = () => {\n\n    if (window._consumptionInitialized) {\n        console.warn(\"⚠️ Módulo de consumo ya inicializado — se omite nueva carga.\");\n        return;\n    }\n    window._consumptionInitialized = true;\n\n    console.log(\"Historial de consumo inicializado ✅\");\n\n    // Elementos del DOM\n    const tableBody = document.getElementById('consumption-table-body');\n    const filterService = document.getElementById('filter-service');\n    const filterAction = document.getElementById('filter-action');\n    const filterFrom = document.getElementById('filter-date-from');\n    const filterTo = document.getElementById('filter-date-to');\n    const prevPageBtn = document.getElementById('prev-page');\n    const nextPageBtn = document.getElementById('next-page');\n    const pageInfo = document.getElementById('page-info');\n\n    // 🧭 Control de ordenamiento\n    let currentSortField = '';\n    let currentSortDir = 'asc';\n\n    // 🆕 Nuevo: Select y input para límite y página\n    const limitSelect = document.getElementById('filter-limit');\n    const pageInput = document.getElementById('filter-page');\n\n    // 📄 Estado inicial\n    let currentPage = parseInt(sessionStorage.getItem('consumptionPage')) || 1;\n    let currentLimit = parseInt(sessionStorage.getItem('consumptionLimit')) || 10;\n\n    const savePage = (page) => sessionStorage.setItem('consumptionPage', page);\n    const saveLimit = (limit) => sessionStorage.setItem('consumptionLimit', limit);\n\n    /**\n     * 🧩 Cargar lista de servicios desde el WS\n     */\n    const loadServices = async () => {\n        try {\n            const response = await Ajax.call([{\n                methodname: 'aiprovider_datacurso_get_services',\n                args: {}\n            }])[0];\n\n            filterService.innerHTML = '<option value=\"all\">Todos los servicios</option>';\n\n            if (response?.services?.length) {\n                response.services.forEach(s => {\n                    const opt = document.createElement('option');\n                    opt.value = s.name;\n                    opt.textContent = s.name;\n                    filterService.appendChild(opt);\n                });\n            }\n        } catch (error) {\n            console.error(\"❌ Error al cargar servicios:\", error);\n        }\n    };\n\n    /**\n     * 🧩 Cargar lista de acciones desde el WS\n     */\n    const loadActions = async () => {\n        try {\n            const response = await Ajax.call([{\n                methodname: 'aiprovider_datacurso_get_actions',\n                args: {}\n            }])[0];\n\n            filterAction.innerHTML = '<option value=\"all\">Todas las acciones</option>';\n\n            if (response?.actions?.length) {\n                response.actions.forEach(a => {\n                    const opt = document.createElement('option');\n                    opt.value = a.id;\n                    opt.textContent = a.name;\n                    filterAction.appendChild(opt);\n                });\n            }\n        } catch (error) {\n            console.error(\"❌ Error al cargar acciones:\", error);\n        }\n    };\n\n    /**\n     * 🧾 Renderizar tabla de consumos\n     */\n    const renderTable = (consumos) => {\n        tableBody.innerHTML = '';\n        if (!consumos || consumos.length === 0) {\n            getString('nodata', 'aiprovider_datacurso').then(nodata => {\n                tableBody.innerHTML = `<tr><td colspan=\"7\">${nodata}</td></tr>`;\n            });\n            pageInfo.textContent = '';\n            prevPageBtn.disabled = true;\n            nextPageBtn.disabled = true;\n            return;\n        }\n\n        consumos.forEach(item => {\n            const row = document.createElement('tr');\n            row.innerHTML = `\n                <td>${item.id_consumption}</td>\n                <td>${item.userid || '-'}</td>\n                <td>${item.action}</td>\n                <td>${item.id_service}</td>\n                <td>${item.cant_tokens}</td>\n                <td>${item.balance}</td>\n                <td>${item.date}</td>\n            `;\n            tableBody.appendChild(row);\n        });\n    };\n\n    /**\n     * 🔍 Obtener historial de consumo con filtros\n     */\n    const fetchData = () => {\n        const serviceValue = filterService.value;\n        const actionValue = filterAction.value;\n        const fromValue = filterFrom.value;\n        const toValue = filterTo.value;\n\n        // 🧠 Parámetros base obligatorios\n        const args = {\n            page: currentPage,\n            limit: currentLimit,\n            servicio: serviceValue !== 'all' ? serviceValue : '',\n            accion: actionValue !== 'all' ? actionValue : '',\n            fechadesde: fromValue || '',\n            fechahasta: toValue || ''\n        };\n\n        // 🆕 Solo agrega el orden si existe campo seleccionado\n        if (currentSortField) {\n            args.short = currentSortField;\n            args.shortdir = currentSortDir;\n        }\n\n        console.log(\"📤 Enviando petición al WS con args:\", JSON.stringify(args));\n\n        Ajax.call([{\n            methodname: 'aiprovider_datacurso_get_consumption_history',\n            args: args\n        }])[0].then(response => {\n            console.log(\"📥 Respuesta del servidor:\", response);\n\n            const consumos = response?.consumption || [];\n            renderTable(consumos);\n\n            // 📑 Paginación\n            const pagination = response?.pagination;\n            if (pagination) {\n                const { current_page, total_pages, total } = pagination;\n                pageInfo.textContent = `Página ${current_page} de ${total_pages} (${total} registros)`;\n\n                // Sincronizar input de página\n                if (pageInput) pageInput.value = current_page;\n\n                prevPageBtn.disabled = current_page <= 1;\n                nextPageBtn.disabled = current_page >= total_pages;\n            } else {\n                pageInfo.textContent = '';\n                prevPageBtn.disabled = true;\n                nextPageBtn.disabled = true;\n            }\n        }).catch(async (e) => {\n            const nodata = await getString('nodata', 'aiprovider_datacurso');\n            tableBody.innerHTML = `<tr><td colspan=\"7\">${nodata}</td></tr>`;\n            console.error(\"❌ Error al obtener historial de consumo:\", e);\n        });\n    };\n\n    // 🎯 Filtros (reinician a página 1)\n    [filterService, filterAction, filterFrom, filterTo].forEach(el => {\n        el.addEventListener('change', () => {\n            currentPage = 1;\n            savePage(currentPage);\n            fetchData();\n        });\n    });\n\n    // ⏮ Página anterior\n    prevPageBtn.addEventListener('click', () => {\n        if (currentPage > 1) {\n            currentPage--;\n            savePage(currentPage);\n            fetchData();\n        }\n    });\n\n    // ⏭ Página siguiente\n    nextPageBtn.addEventListener('click', () => {\n        currentPage++;\n        savePage(currentPage);\n        fetchData();\n    });\n\n    // 🆕 Cambio manual del límite\n    if (limitSelect) {\n        limitSelect.value = currentLimit;\n        limitSelect.addEventListener('change', () => {\n            currentLimit = parseInt(limitSelect.value);\n            saveLimit(currentLimit);\n            currentPage = 1;\n            savePage(currentPage);\n            fetchData();\n        });\n    }\n\n    // 🆕 Cambio manual de número de página\n    if (pageInput) {\n        pageInput.addEventListener('change', () => {\n            const newPage = parseInt(pageInput.value);\n            if (newPage && newPage > 0) {\n                currentPage = newPage;\n                savePage(currentPage);\n                fetchData();\n            }\n        });\n    }\n\n    // 🆕 Ordenamiento general por columnas\n    document.querySelectorAll('.sortable').forEach(header => {\n        header.addEventListener('click', () => {\n            const field = header.dataset.sort;\n            const icon = header.querySelector('.sort-icon');\n\n            // Si se hace clic en la misma columna, alterna el orden\n            if (currentSortField === field) {\n                currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';\n            } else {\n                // Si es una nueva columna, empieza en asc\n                currentSortField = field;\n                currentSortDir = 'asc';\n            }\n\n            // Resetear íconos\n            document.querySelectorAll('.sort-icon').forEach(i => {\n                i.className = 'fa fa-sort sort-icon';\n            });\n\n            // Actualizar ícono activo\n            icon.className = currentSortDir === 'asc'\n                ? 'fa fa-sort-up sort-icon'\n                : 'fa fa-sort-down sort-icon';\n\n            // Reiniciar a página 1 y recargar\n            currentPage = 1;\n            savePage(currentPage);\n            fetchData();\n        });\n    });\n\n    // 🚀 Carga inicial\n    Promise.all([loadServices(), loadActions()])\n        .then(() => fetchData())\n        .catch(e => console.error(\"❌ Error durante carga inicial:\", e));\n};\n"],"names":["window","_consumptionInitialized","console","warn","log","tableBody","document","getElementById","filterService","filterAction","filterFrom","filterTo","prevPageBtn","nextPageBtn","pageInfo","currentSortField","currentSortDir","limitSelect","pageInput","currentPage","parseInt","sessionStorage","getItem","currentLimit","savePage","page","setItem","fetchData","serviceValue","value","actionValue","fromValue","toValue","args","limit","servicio","accion","fechadesde","fechahasta","short","shortdir","JSON","stringify","call","methodname","then","response","consumos","innerHTML","length","nodata","textContent","disabled","forEach","item","row","createElement","id_consumption","userid","action","id_service","cant_tokens","balance","date","appendChild","renderTable","consumption","pagination","current_page","total_pages","total","catch","async","error","e","el","addEventListener","newPage","querySelectorAll","header","field","dataset","sort","icon","querySelector","i","className","Promise","all","Ajax","services","_response$services","s","opt","name","loadServices","actions","_response$actions","a","id","loadActions"],"mappings":"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"}