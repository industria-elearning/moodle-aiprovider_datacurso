{"version":3,"file":"consumption.min.js","sources":["../src/consumption.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Consumption history table management.\n *\n * @module     aiprovider_datacurso/consumption\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable */\nimport Ajax from 'core/ajax';\nimport { get_string as getString } from 'core/str';\n\nexport const init = () => {\n\n    if (window._consumptionInitialized) {\n        console.warn(\"‚ö†Ô∏è M√≥dulo de consumo ya inicializado ‚Äî se omite nueva carga.\");\n        return;\n    }\n    window._consumptionInitialized = true;\n\n    console.log(\"Historial de consumo inicializado ‚úÖ\");\n\n    // Elementos del DOM\n    const tableBody = document.getElementById('consumption-table-body');\n    const filterService = document.getElementById('filter-service');\n    const filterAction = document.getElementById('filter-action');\n    const filterFrom = document.getElementById('filter-date-from');\n    const filterTo = document.getElementById('filter-date-to');\n    const prevPageBtn = document.getElementById('prev-page');\n    const nextPageBtn = document.getElementById('next-page');\n    const pageInfo = document.getElementById('page-info');\n\n    // üÜï Nuevo: Select y input para l√≠mite y p√°gina\n    const limitSelect = document.getElementById('filter-limit');\n    const pageInput = document.getElementById('filter-page');\n\n    // üìÑ Estado inicial\n    let currentPage = parseInt(sessionStorage.getItem('consumptionPage')) || 1;\n    let currentLimit = parseInt(sessionStorage.getItem('consumptionLimit')) || 10;\n\n    const savePage = (page) => sessionStorage.setItem('consumptionPage', page);\n    const saveLimit = (limit) => sessionStorage.setItem('consumptionLimit', limit);\n\n    /**\n     * üß© Cargar lista de servicios desde el WS\n     */\n    const loadServices = async () => {\n        try {\n            const response = await Ajax.call([{\n                methodname: 'aiprovider_datacurso_get_services',\n                args: {}\n            }])[0];\n\n            filterService.innerHTML = '<option value=\"all\">Todos los servicios</option>';\n\n            if (response?.services?.length) {\n                response.services.forEach(s => {\n                    const opt = document.createElement('option');\n                    opt.value = s.name;\n                    opt.textContent = s.name;\n                    filterService.appendChild(opt);\n                });\n            }\n        } catch (error) {\n            console.error(\"‚ùå Error al cargar servicios:\", error);\n        }\n    };\n\n    /**\n     * üß© Cargar lista de acciones desde el WS\n     */\n    const loadActions = async () => {\n        try {\n            const response = await Ajax.call([{\n                methodname: 'aiprovider_datacurso_get_actions',\n                args: {}\n            }])[0];\n\n            filterAction.innerHTML = '<option value=\"all\">Todas las acciones</option>';\n\n            if (response?.actions?.length) {\n                response.actions.forEach(a => {\n                    const opt = document.createElement('option');\n                    opt.value = a.id;\n                    opt.textContent = a.name;\n                    filterAction.appendChild(opt);\n                });\n            }\n        } catch (error) {\n            console.error(\"‚ùå Error al cargar acciones:\", error);\n        }\n    };\n\n    /**\n     * üßæ Renderizar tabla de consumos\n     */\n    const renderTable = (consumos) => {\n        tableBody.innerHTML = '';\n        if (!consumos || consumos.length === 0) {\n            getString('nodata', 'aiprovider_datacurso').then(nodata => {\n                tableBody.innerHTML = `<tr><td colspan=\"7\">${nodata}</td></tr>`;\n            });\n            pageInfo.textContent = '';\n            prevPageBtn.disabled = true;\n            nextPageBtn.disabled = true;\n            return;\n        }\n\n        consumos.forEach(item => {\n            const row = document.createElement('tr');\n            row.innerHTML = `\n                <td>${item.id_consumption}</td>\n                <td>${item.userid || '-'}</td>\n                <td>${item.action}</td>\n                <td>${item.id_service}</td>\n                <td>${item.cant_tokens}</td>\n                <td>${item.balance}</td>\n                <td>${item.date}</td>\n            `;\n            tableBody.appendChild(row);\n        });\n    };\n\n    /**\n     * üîç Obtener historial de consumo con filtros\n     */\n    const fetchData = () => {\n        const serviceValue = filterService.value;\n        const actionValue = filterAction.value;\n        const fromValue = filterFrom.value;\n        const toValue = filterTo.value;\n\n        const args = {\n            page: currentPage,\n            limit: currentLimit,\n            servicio: serviceValue !== 'all' ? serviceValue : '',\n            accion: actionValue !== 'all' ? actionValue : '',\n            fechadesde: fromValue || '',\n            fechahasta: toValue || ''\n        };\n\n        console.log(\"üì§ Enviando petici√≥n al WS con args:\", JSON.stringify(args));\n\n        Ajax.call([{\n            methodname: 'aiprovider_datacurso_get_consumption_history',\n            args: args\n        }])[0].then(response => {\n            console.log(\"üì• Respuesta del servidor:\", response);\n\n            const consumos = response?.consumption || [];\n            renderTable(consumos);\n\n            // üìë Paginaci√≥n\n            const pagination = response?.pagination;\n            if (pagination) {\n                const { current_page, total_pages, total } = pagination;\n                pageInfo.textContent = `P√°gina ${current_page} de ${total_pages} (${total} registros)`;\n\n                // Sincronizar input de p√°gina\n                if (pageInput) pageInput.value = current_page;\n\n                prevPageBtn.disabled = current_page <= 1;\n                nextPageBtn.disabled = current_page >= total_pages;\n            } else {\n                pageInfo.textContent = '';\n                prevPageBtn.disabled = true;\n                nextPageBtn.disabled = true;\n            }\n        }).catch(async (e) => {\n            const nodata = await getString('nodata', 'aiprovider_datacurso');\n            tableBody.innerHTML = `<tr><td colspan=\"7\">${nodata}</td></tr>`;\n            console.error(\"‚ùå Error al obtener historial de consumo:\", e);\n        });\n    };\n\n    // üéØ Filtros (reinician a p√°gina 1)\n    [filterService, filterAction, filterFrom, filterTo].forEach(el => {\n        el.addEventListener('change', () => {\n            currentPage = 1;\n            savePage(currentPage);\n            fetchData();\n        });\n    });\n\n    // ‚èÆ P√°gina anterior\n    prevPageBtn.addEventListener('click', () => {\n        if (currentPage > 1) {\n            currentPage--;\n            savePage(currentPage);\n            fetchData();\n        }\n    });\n\n    // ‚è≠ P√°gina siguiente\n    nextPageBtn.addEventListener('click', () => {\n        currentPage++;\n        savePage(currentPage);\n        fetchData();\n    });\n\n    // üÜï Cambio manual del l√≠mite\n    if (limitSelect) {\n        limitSelect.value = currentLimit;\n        limitSelect.addEventListener('change', () => {\n            currentLimit = parseInt(limitSelect.value);\n            saveLimit(currentLimit);\n            currentPage = 1;\n            savePage(currentPage);\n            fetchData();\n        });\n    }\n\n    // üÜï Cambio manual de n√∫mero de p√°gina\n    if (pageInput) {\n        pageInput.addEventListener('change', () => {\n            const newPage = parseInt(pageInput.value);\n            if (newPage && newPage > 0) {\n                currentPage = newPage;\n                savePage(currentPage);\n                fetchData();\n            }\n        });\n    }\n\n    // üöÄ Carga inicial\n    Promise.all([loadServices(), loadActions()])\n        .then(() => fetchData())\n        .catch(e => console.error(\"‚ùå Error durante carga inicial:\", e));\n};\n"],"names":["window","_consumptionInitialized","console","warn","log","tableBody","document","getElementById","filterService","filterAction","filterFrom","filterTo","prevPageBtn","nextPageBtn","pageInfo","limitSelect","pageInput","currentPage","parseInt","sessionStorage","getItem","currentLimit","savePage","page","setItem","fetchData","serviceValue","value","actionValue","fromValue","toValue","args","limit","servicio","accion","fechadesde","fechahasta","JSON","stringify","call","methodname","then","response","consumos","innerHTML","length","nodata","textContent","disabled","forEach","item","row","createElement","id_consumption","userid","action","id_service","cant_tokens","balance","date","appendChild","renderTable","consumption","pagination","current_page","total_pages","total","catch","async","error","e","el","addEventListener","newPage","Promise","all","Ajax","services","_response$services","s","opt","name","loadServices","actions","_response$actions","a","id","loadActions"],"mappings":"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"}