{"version":3,"file":"consumption.min.js","sources":["../src/consumption.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Consumption history table management.\n *\n * @module     aiprovider_datacurso/consumption\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport { get_string as getString } from 'core/str';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\nexport const init = async () => {\n\n    // Elements DOM\n    const filterService = document.getElementById('filter-service');\n    const filterAction = document.getElementById('filter-action');\n    const filterFrom = document.getElementById('filter-date-from');\n    const filterTo = document.getElementById('filter-date-to');\n    const prevPageBtn = document.getElementById('prev-page');\n    const nextPageBtn = document.getElementById('next-page');\n    const pageInfo = document.getElementById('page-info');\n\n    // Order\n    let currentSortField = '';\n    let currentSortDir = 'asc';\n\n    // Select and input for limit and page\n    const limitSelect = document.getElementById('filter-limit');\n    const pageInput = document.getElementById('filter-page');\n\n    // Init status\n    let currentPage = parseInt(sessionStorage.getItem('consumptionPage')) || 1;\n    let currentLimit = parseInt(sessionStorage.getItem('consumptionLimit')) || 10;\n\n    const savePage = (page) => sessionStorage.setItem('consumptionPage', page);\n    const saveLimit = (limit) => sessionStorage.setItem('consumptionLimit', limit);\n\n    const loadServices = async () => {\n        try {\n            const response = await Ajax.call([{\n                methodname: 'aiprovider_datacurso_get_services',\n                args: {}\n            }])[0];\n\n            if (response?.services?.length) {\n                response.services.forEach(s => {\n                    const opt = document.createElement('option');\n                    opt.value = s.name;\n                    opt.textContent = s.name;\n                    filterService.appendChild(opt);\n                });\n            }\n        } catch (error) {\n            Notification.exception(error);\n            return [];\n        }\n    };\n\n    const loadActions = async () => {\n        try {\n            const response = await Ajax.call([{\n                methodname: 'aiprovider_datacurso_get_actions',\n                args: {}\n            }])[0];\n\n            if (response?.actions?.length) {\n                response.actions.forEach(a => {\n                    const opt = document.createElement('option');\n                    opt.value = a.id;\n                    opt.textContent = a.name;\n                    filterAction.appendChild(opt);\n                });\n            }\n        } catch (error) {\n            Notification.exception(error);\n            return [];\n        }\n    };\n\n    const renderTable = async (listconsumptions) => {\n        const tableBody = document.getElementById('consumption-table-body');\n        const context = { consumptions: listconsumptions };\n        try {\n            if (!listconsumptions || listconsumptions.length === 0) {\n                const nodata = await Templates.render('aiprovider_datacurso/consumption_row', context);\n                tableBody.innerHTML = nodata;\n                return;\n            }\n\n            const html = await Templates.render('aiprovider_datacurso/consumption_row', context);\n\n            tableBody.innerHTML = html;\n\n        } catch (error) {\n            Notification.exception(error);\n            const nodata = await Templates.render('aiprovider_datacurso/consumption_row', context);\n            tableBody.innerHTML = nodata;\n        }\n    };\n\n    // Get history with filters\n    const fetchData = () => {\n        const serviceValue = filterService.value;\n        const actionValue = filterAction.value;\n        const fromValue = filterFrom.value;\n        const toValue = filterTo.value;\n\n        const args = {\n            page: currentPage,\n            limit: currentLimit,\n            service: serviceValue !== 'all' ? serviceValue : '',\n            action: actionValue !== 'all' ? actionValue : '',\n            fromdate: fromValue || '',\n            todate: toValue || ''\n        };\n\n        if (currentSortField) {\n            args.shor = currentSortField;\n            args.shordir = currentSortDir;\n        }\n\n        Ajax.call([{\n            methodname: 'aiprovider_datacurso_get_consumption_history',\n            args: args\n        }])[0].then(async (response) => {\n\n            const consumptions = response?.consumption || [];\n            renderTable(consumptions);\n\n            const pagination = response?.pagination;\n            if (pagination) {\n                const { current_page, total_pages, total } = pagination;\n                const pageInfoText = await getString('pageinfo', 'aiprovider_datacurso', {\n                    current: current_page,\n                    totalpages: total_pages,\n                    total: total\n                });\n                pageInfo.textContent = pageInfoText;\n                if (pageInput) {\n                    pageInput.value = current_page;\n                }\n                prevPageBtn.disabled = current_page <= 1;\n                nextPageBtn.disabled = current_page >= total_pages;\n            } else {\n                pageInfo.textContent = '';\n                prevPageBtn.disabled = true;\n                nextPageBtn.disabled = true;\n            }\n        })\n            .catch((error) => {\n                Notification.exception(error);\n                return [];\n            });\n    };\n\n    // Event listeners for filters\n    [filterService, filterAction, filterFrom, filterTo].forEach(el => {\n        el.addEventListener('change', () => {\n            currentPage = 1;\n            savePage(currentPage);\n            fetchData();\n        });\n    });\n\n    prevPageBtn.addEventListener('click', () => {\n        if (currentPage > 1) {\n            currentPage--;\n            savePage(currentPage);\n            fetchData();\n        }\n    });\n\n    nextPageBtn.addEventListener('click', () => {\n        currentPage++;\n        savePage(currentPage);\n        fetchData();\n    });\n\n    if (limitSelect) {\n        limitSelect.value = currentLimit;\n        limitSelect.addEventListener('change', () => {\n            currentLimit = parseInt(limitSelect.value);\n            saveLimit(currentLimit);\n            currentPage = 1;\n            savePage(currentPage);\n            fetchData();\n        });\n    }\n\n    if (pageInput) {\n        pageInput.addEventListener('change', () => {\n            const newPage = parseInt(pageInput.value);\n            if (newPage && newPage > 0) {\n                currentPage = newPage;\n                savePage(currentPage);\n                fetchData();\n            }\n        });\n    }\n\n    // Sortable columns\n    document.querySelectorAll('.sortable').forEach(header => {\n        header.addEventListener('click', () => {\n            const field = header.dataset.sort;\n            const icon = header.querySelector('.sort-icon');\n\n            if (currentSortField === field) {\n                currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';\n            } else {\n                currentSortField = field;\n                currentSortDir = 'asc';\n            }\n\n            document.querySelectorAll('.sort-icon').forEach(i => {\n                i.className = 'fa fa-sort sort-icon';\n            });\n\n            icon.className = currentSortDir === 'asc'\n                ? 'fa fa-sort-up sort-icon'\n                : 'fa fa-sort-down sort-icon';\n\n            currentPage = 1;\n            savePage(currentPage);\n            fetchData();\n        });\n    });\n\n    // Initial load\n    Promise.all([loadServices(), loadActions()])\n        .then(() => fetchData())\n        .catch(Notification.exception);\n};\n"],"names":["async","filterService","document","getElementById","filterAction","filterFrom","filterTo","prevPageBtn","nextPageBtn","pageInfo","currentSortField","currentSortDir","limitSelect","pageInput","currentPage","parseInt","sessionStorage","getItem","currentLimit","savePage","page","setItem","fetchData","serviceValue","value","actionValue","fromValue","toValue","args","limit","service","action","fromdate","todate","shor","shordir","call","methodname","then","tableBody","context","consumptions","listconsumptions","length","nodata","Templates","render","innerHTML","html","error","exception","renderTable","response","consumption","pagination","current_page","total_pages","total","pageInfoText","current","totalpages","textContent","disabled","catch","forEach","el","addEventListener","newPage","querySelectorAll","header","field","dataset","sort","icon","querySelector","i","className","Promise","all","Ajax","services","_response$services","s","opt","createElement","name","appendChild","loadServices","actions","_response$actions","a","id","loadActions","Notification"],"mappings":"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"}