{"version":3,"file":"consumption.min.js","sources":["../src/consumption.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Consumption history table management.\n *\n * @module     aiprovider_datacurso/consumption\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from \"core/ajax\";\nimport { get_string as getString } from \"core/str\";\nimport Templates from \"core/templates\";\nimport Notification from \"core/notification\";\nimport { getConsumptionHistory } from \"aiprovider_datacurso/repository\";\n\nexport const init = async () => {\n  // Elements DOM\n  const filterService = document.getElementById(\"filter-service\");\n  const filterAction = document.getElementById(\"filter-action\");\n  const filterFrom = document.getElementById(\"filter-date-from\");\n  const filterTo = document.getElementById(\"filter-date-to\");\n  const prevPageBtn = document.getElementById(\"prev-page\");\n  const nextPageBtn = document.getElementById(\"next-page\");\n  const pageInfo = document.getElementById(\"page-info\");\n  const tableRegionSelector =\n    '[data-region=\"aiprovider_datacurso/consumption-table\"]';\n\n  // Order\n  let currentSortField = \"\";\n  let currentSortDir = \"asc\";\n\n  // Select and input for limit and page\n  const limitSelect = document.getElementById(\"filter-limit\");\n  const pageInput = document.getElementById(\"filter-page\");\n\n  // Init status\n  let currentPage = parseInt(sessionStorage.getItem(\"consumptionPage\")) || 1;\n  let currentLimit = parseInt(sessionStorage.getItem(\"consumptionLimit\")) || 10;\n\n  const savePage = (page) => sessionStorage.setItem(\"consumptionPage\", page);\n  const saveLimit = (limit) =>\n    sessionStorage.setItem(\"consumptionLimit\", limit);\n\n  const updateSortIndicators = () => {\n    document\n      .querySelectorAll(`${tableRegionSelector} .sort-icon`)\n      .forEach((icon) => {\n        icon.className = \"fa fa-sort sort-icon\";\n      });\n\n    if (!currentSortField) {\n      return;\n    }\n\n    const activeHeader = document.querySelector(\n      `${tableRegionSelector} [data-sort=\"${currentSortField}\"] .sort-icon`\n    );\n    if (activeHeader) {\n      activeHeader.className =\n        currentSortDir === \"asc\"\n          ? \"fa fa-sort-up sort-icon\"\n          : \"fa fa-sort-down sort-icon\";\n    }\n  };\n\n  const bindSortingHandlers = () => {\n    document\n      .querySelectorAll(`${tableRegionSelector} .sortable`)\n      .forEach((header) => {\n        header.addEventListener(\"click\", () => {\n          const field = header.dataset.sort;\n          if (!field) {\n            return;\n          }\n\n          if (currentSortField === field) {\n            currentSortDir = currentSortDir === \"asc\" ? \"desc\" : \"asc\";\n          } else {\n            currentSortField = field;\n            currentSortDir = \"asc\";\n          }\n\n          updateSortIndicators();\n          currentPage = 1;\n          savePage(currentPage);\n          fetchData();\n        });\n      });\n\n    updateSortIndicators();\n  };\n\n  const loadServices = async () => {\n    try {\n      const response = await Ajax.call([\n        {\n          methodname: \"aiprovider_datacurso_get_services\",\n          args: {},\n        },\n      ])[0];\n\n      if (response?.services?.length) {\n        response.services.forEach((s) => {\n          const opt = document.createElement(\"option\");\n          opt.value = s.id;\n          opt.textContent = s.name;\n          filterService.appendChild(opt);\n        });\n      }\n    } catch (error) {\n      Notification.exception(error);\n      return [];\n    }\n  };\n\n  const loadActions = async () => {\n    try {\n      const response = await Ajax.call([\n        {\n          methodname: \"aiprovider_datacurso_get_actions\",\n          args: {},\n        },\n      ])[0];\n\n      if (response?.actions?.length) {\n        response.actions.forEach((a) => {\n          const opt = document.createElement(\"option\");\n          opt.value = a.id;\n          opt.textContent = a.name;\n          filterAction.appendChild(opt);\n        });\n      }\n    } catch (error) {\n      Notification.exception(error);\n      return [];\n    }\n  };\n\n  const renderTable = async (listconsumptions, { loading = false } = {}) => {\n    const container = document.querySelector(tableRegionSelector);\n    if (!container) {\n      return;\n    }\n\n    const consumptions = Array.isArray(listconsumptions)\n      ? listconsumptions\n      : [];\n    const context = {\n      initialized: !loading,\n      consumptions: consumptions,\n    };\n\n    try {\n      const render = await Templates.renderForPromise(\n        \"aiprovider_datacurso/consumption_row\",\n        context\n      );\n      await Templates.replaceNodeContents(container, render.html, render.js);\n      bindSortingHandlers();\n    } catch (error) {\n      Notification.exception(error);\n      const fallback = await Templates.renderForPromise(\n        \"aiprovider_datacurso/consumption_row\",\n        {\n          initialized: true,\n          consumptions: [],\n        }\n      );\n      await Templates.replaceNodeContents(\n        container,\n        fallback.html,\n        fallback.js\n      );\n      bindSortingHandlers();\n    }\n  };\n\n  // Get history with filters\n  const fetchData = async () => {\n    const serviceValue = filterService.value;\n    const actionValue = filterAction.value;\n    const fromValue = filterFrom.value;\n    const toValue = filterTo.value;\n\n    const args = {\n      page: currentPage,\n      limit: currentLimit,\n      service: serviceValue !== \"all\" ? serviceValue : \"\",\n      action: actionValue !== \"all\" ? actionValue : \"\",\n      fromdate: fromValue || \"\",\n      todate: toValue || \"\",\n    };\n\n    if (currentSortField) {\n      args.shor = currentSortField;\n      args.shordir = currentSortDir;\n    }\n\n    await renderTable([], { loading: true });\n\n    const response = await getConsumptionHistory(args);\n\n    const consumptions = response?.consumption || [];\n    await renderTable(consumptions);\n\n    const pagination = response?.pagination;\n    if (pagination) {\n      const { current_page, total_pages, total } = pagination;\n      const pageInfoText = await getString(\"pageinfo\", \"aiprovider_datacurso\", {\n        current: current_page,\n        totalpages: total_pages,\n        total: total,\n      });\n      pageInfo.textContent = pageInfoText;\n      if (pageInput) {\n        pageInput.value = current_page;\n      }\n      prevPageBtn.disabled = current_page <= 1;\n      nextPageBtn.disabled = current_page >= total_pages;\n    } else {\n      pageInfo.textContent = \"\";\n      prevPageBtn.disabled = true;\n      nextPageBtn.disabled = true;\n    }\n  };\n\n  // Event listeners for filters\n  [filterService, filterAction, filterFrom, filterTo].forEach((el) => {\n    el.addEventListener(\"change\", () => {\n      currentPage = 1;\n      savePage(currentPage);\n      fetchData();\n    });\n  });\n\n  prevPageBtn.addEventListener(\"click\", () => {\n    if (currentPage > 1) {\n      currentPage--;\n      savePage(currentPage);\n      fetchData();\n    }\n  });\n\n  nextPageBtn.addEventListener(\"click\", () => {\n    currentPage++;\n    savePage(currentPage);\n    fetchData();\n  });\n\n  if (limitSelect) {\n    limitSelect.value = currentLimit;\n    limitSelect.addEventListener(\"change\", () => {\n      currentLimit = parseInt(limitSelect.value);\n      saveLimit(currentLimit);\n      currentPage = 1;\n      savePage(currentPage);\n      fetchData();\n    });\n  }\n\n  if (pageInput) {\n    pageInput.addEventListener(\"change\", () => {\n      const newPage = parseInt(pageInput.value);\n      if (newPage && newPage > 0) {\n        currentPage = newPage;\n        savePage(currentPage);\n        fetchData();\n      }\n    });\n  }\n\n  // Initial load\n  Promise.all([loadServices(), loadActions()])\n    .then(() => fetchData())\n    .catch(Notification.exception);\n\n  bindSortingHandlers();\n};\n"],"names":["async","filterService","document","getElementById","filterAction","filterFrom","filterTo","prevPageBtn","nextPageBtn","pageInfo","tableRegionSelector","currentSortField","currentSortDir","limitSelect","pageInput","currentPage","parseInt","sessionStorage","getItem","currentLimit","savePage","page","setItem","updateSortIndicators","querySelectorAll","forEach","icon","className","activeHeader","querySelector","bindSortingHandlers","header","addEventListener","field","dataset","sort","fetchData","renderTable","listconsumptions","loading","container","consumptions","Array","isArray","context","initialized","render","Templates","renderForPromise","replaceNodeContents","html","js","error","exception","fallback","serviceValue","value","actionValue","fromValue","toValue","args","limit","service","action","fromdate","todate","shor","shordir","response","consumption","pagination","current_page","total_pages","total","pageInfoText","current","totalpages","textContent","disabled","el","newPage","Promise","all","Ajax","call","methodname","services","_response$services","length","s","opt","createElement","id","name","appendChild","loadServices","actions","_response$actions","a","loadActions","then","catch","Notification"],"mappings":"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"}