{"version":3,"file":"report_charts.min.js","sources":["../src/report_charts.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Report charts module.\n *\n * @module     aiprovider_datacurso/report_charts\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable */\nimport Ajax from 'core/ajax';\nimport Chart from 'core/chartjs';\n\nexport const init = () => {\n    const tokensAvailable = document.getElementById('tokens-available');\n    const tokensConsumed = document.getElementById('tokens-consumed');\n\n    let chartBar, chartPie, chartDay;\n    let cachedData = []; // data global\n\n    // call init \n    Promise.all([\n        Ajax.call([{ methodname: 'aiprovider_datacurso_get_tokens_saldo', args: {} }])[0],\n        Ajax.call([{ methodname: 'aiprovider_datacurso_get_services', args: {} }])[0],\n        Ajax.call([{ methodname: 'aiprovider_datacurso_get_all_consumption', args: {} }])[0],\n    ])\n        .then(([saldoResponse, servicesResponse, consumptionResponse]) => {\n\n            const saldo = saldoResponse?.saldo_actual || 0;\n            tokensAvailable.textContent = saldo;\n\n            const servicios = servicesResponse?.services || [];\n            cachedData = consumptionResponse?.consumption || []; // data global first\n\n            initCharts(servicios);\n\n        }).catch(err => console.error(\"Error:\", err));\n\n    // init grafic\n    const initCharts = (servicios) => {\n        const filterBar = document.getElementById('filter-service-bar');\n        const filterPie = document.getElementById('filter-service-pie');\n        const filterStart = document.getElementById('filter-start-date');\n        const filterEnd = document.getElementById('filter-end-date');\n\n        const fillSelect = (select) => {\n            select.innerHTML = '<option value=\"\">Todos</option>';\n            if (servicios?.length) {\n                servicios.forEach(s => {\n                    const opt = document.createElement('option');\n                    opt.value = s.name;\n                    opt.textContent = s.name;\n                    select.appendChild(opt);\n                });\n            }\n        };\n\n        fillSelect(filterBar);\n        fillSelect(filterPie);\n\n        // Render inicial usando cachedData\n        renderBarChart(cachedData);\n        renderPieChart(cachedData);\n        renderDayChart(cachedData);\n\n        // Listeners de filtros\n        filterBar.addEventListener('change', () => updateBarChart());\n        filterPie.addEventListener('change', () => updatePieChart());\n        filterStart.addEventListener('change', () => updateDayChart());\n        filterEnd.addEventListener('change', () => updateDayChart());\n    };\n\n    // functions ws\n    const fetchConsumptionData = async (params = {}) => {\n        const defaults = {\n            servicio: \"\",\n            accion: \"\",\n            fechadesde: \"\",\n            fechahasta: \"\"\n        };\n        const finalParams = { ...defaults, ...params };\n\n        try {\n            const response = await Ajax.call([{\n                methodname: 'aiprovider_datacurso_get_all_consumption',\n                args: finalParams\n            }])[0];\n\n            if (response.status !== 'success') {\n                console.warn(\"⚠️ WS devolvió estado:\", response.status);\n                return [];\n            }\n            return response.consumption || [];\n\n        } catch (error) {\n            console.error(\"❌ Error al obtener consumos:\", error);\n            return [];\n        }\n    };\n\n    // grafic barra\n    const renderBarChart = (data) => {\n        const byMonth = {};\n        data.forEach(c => {\n            const month = c.date.substring(0, 7);\n            byMonth[month] = (byMonth[month] || 0) + c.cant_tokens;\n        });\n\n        const totalTokens = data.reduce((sum, c) => sum + (c.cant_tokens || 0), 0);\n        tokensConsumed.textContent = totalTokens;\n\n        const ctx = document.getElementById('chart-tokens-by-month');\n        if (chartBar) chartBar.destroy();\n\n        chartBar = new Chart(ctx, {\n            type: 'bar',\n            data: {\n                labels: Object.keys(byMonth),\n                datasets: [{\n                    label: 'Tokens consumidos por mes',\n                    data: Object.values(byMonth),\n                    backgroundColor: '#0073e6',\n                }]\n            },\n            options: { responsive: true, maintainAspectRatio: false }\n        });\n    };\n\n    const updateBarChart = async () => {\n        const servicio = document.getElementById('filter-service-bar').value;\n        if (!servicio) return renderBarChart(cachedData); // usa la cache si no hay filtro\n\n        const data = await fetchConsumptionData({ servicio });\n        renderBarChart(data);\n    };\n\n    // grafic pai\n    const renderPieChart = (data) => {\n        const byAction = {};\n        data.forEach(c => {\n            byAction[c.action] = (byAction[c.action] || 0) + c.cant_tokens;\n        });\n\n        const ctx = document.getElementById('chart-actions');\n        if (chartPie) chartPie.destroy();\n\n        chartPie = new Chart(ctx, {\n            type: 'pie',\n            data: {\n                labels: Object.keys(byAction),\n                datasets: [{\n                    data: Object.values(byAction),\n                    backgroundColor: [\n                        '#36A2EB',\n                        '#FF6384',\n                        '#f1d48bff',\n                        '#4BC0C0',\n                        '#0f9c9cff',\n                        '#0b6eb0ff',\n                        '#d10f39ff',\n                        '#c18f12ff',\n                        '#457f7fff',\n                        '#a50562ff',\n                        '#4BC0C0',\n                        '#efef21ff',\n                        '#252f2fff',\n                        '#8f9191ff'],\n                }]\n            },\n            options: { responsive: true, maintainAspectRatio: false }\n        });\n    };\n\n    const updatePieChart = async () => {\n        const servicio = document.getElementById('filter-service-pie').value;\n        if (!servicio) return renderPieChart(cachedData);\n\n        const data = await fetchConsumptionData({ servicio });\n        renderPieChart(data);\n    };\n\n    // grafic day\n    const renderDayChart = (data) => {\n        const byDay = {};\n        data.forEach(c => {\n            const day = c.date.substring(0, 10);\n            byDay[day] = (byDay[day] || 0) + c.cant_tokens;\n        });\n\n        const labels = Object.keys(byDay).sort((a, b) => new Date(a) - new Date(b));\n        const values = labels.map(day => byDay[day]);\n\n        const ctx = document.getElementById('chart-tokens-by-day');\n        if (chartDay) chartDay.destroy();\n\n        chartDay = new Chart(ctx, {\n            type: 'line',\n            data: {\n                labels,\n                datasets: [{\n                    label: 'Tokens consumidos por día',\n                    data: values,\n                    borderColor: '#28a745',\n                    backgroundColor: 'rgba(40,167,69,0.2)',\n                    fill: true,\n                    tension: 0.2,\n                    pointRadius: 4,\n                    pointHoverRadius: 6,\n                    borderWidth: 2\n                }]\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                scales: {\n                    x: { title: { display: true, text: 'Fecha' } },\n                    y: { title: { display: true, text: 'Tokens consumidos' }, beginAtZero: true }\n                }\n            }\n        });\n    };\n\n    const updateDayChart = async () => {\n        const fechadesde = document.getElementById('filter-start-date').value;\n        const fechahasta = document.getElementById('filter-end-date').value;\n\n        if (!fechadesde && !fechahasta) return renderDayChart(cachedData);\n\n        const data = await fetchConsumptionData({ fechadesde, fechahasta });\n        renderDayChart(data);\n    };\n};\n"],"names":["tokensAvailable","document","getElementById","tokensConsumed","chartBar","chartPie","chartDay","cachedData","Promise","all","Ajax","call","methodname","args","then","_ref","saldoResponse","servicesResponse","consumptionResponse","saldo","saldo_actual","textContent","servicios","services","consumption","initCharts","catch","err","console","error","filterBar","filterPie","filterStart","filterEnd","fillSelect","select","innerHTML","length","forEach","s","opt","createElement","value","name","appendChild","renderBarChart","renderPieChart","renderDayChart","addEventListener","updateBarChart","updatePieChart","updateDayChart","fetchConsumptionData","async","params","defaults","servicio","accion","fechadesde","fechahasta","finalParams","response","status","warn","data","byMonth","c","month","date","substring","cant_tokens","totalTokens","reduce","sum","ctx","destroy","Chart","type","labels","Object","keys","datasets","label","values","backgroundColor","options","responsive","maintainAspectRatio","byAction","action","byDay","day","sort","a","b","Date","map","borderColor","fill","tension","pointRadius","pointHoverRadius","borderWidth","scales","x","title","display","text","y","beginAtZero"],"mappings":"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"}