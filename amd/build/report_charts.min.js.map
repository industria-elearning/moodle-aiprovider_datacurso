{"version":3,"file":"report_charts.min.js","sources":["../src/report_charts.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Report charts module.\n *\n * @module     aiprovider_datacurso/report_charts\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable */\n\nimport Ajax from 'core/ajax';\nimport Chart from 'core/chartjs';\nimport {get_string as getString} from 'core/str';\n\nexport const init = () => {\n\n    const tokensAvailable = document.getElementById('tokens-available');\n    const tokensConsumed = document.getElementById('tokens-consumed');\n    const tableBody = document.getElementById('consumption-table-body');\n\n    let consumos = [];\n    let chartBar, chartPie;\n\n    // 🔹 1. Llamadas a los WS\n    Promise.all([\n        Ajax.call([{ methodname: 'aiprovider_datacurso_get_consumption_history', args: {} }])[0],\n        Ajax.call([{ methodname: 'aiprovider_datacurso_get_tokens_saldo', args: {} }])[0],\n    ]).then(async ([historyResponse, saldoResponse]) => {\n        consumos = historyResponse?.consumos || [];\n        const saldo = saldoResponse?.saldo_actual || 0;\n\n        // 🔹 2. Actualizar cards\n        tokensAvailable.textContent = saldo;\n        tokensConsumed.textContent = consumos.reduce((sum, c) => sum + (c.cantidad_tokens || 0), 0);\n\n        // 🔹 3. Renderizar tabla\n        renderTable(consumos, tableBody);\n\n        // 🔹 4. Inicializar filtros y charts\n        initCharts(consumos);\n\n    }).catch(err => {\n        console.error(\"❌ Error WS\", err);\n    });\n\n    // 🔹 Tabla dinámica\n    const renderTable = async (data, container) => {\n        container.innerHTML = '';\n        if (!data.length) {\n            const nodata = await getString('nodata', 'aiprovider_datacurso');\n            container.innerHTML = `<tr><td colspan=\"7\" class=\"text-center\">${nodata}</td></tr>`;\n            return;\n        }\n        data.forEach(item => {\n            const row = document.createElement('tr');\n            row.innerHTML = `\n                <td>${item.id_consumo}</td>\n                <td>${item.id_usuario}</td>\n                <td>${item.accion}</td>\n                <td>${item.servicio}</td>\n                <td>${item.cantidad_tokens}</td>\n                <td>${item.saldo_restante}</td>\n                <td>${item.fecha}</td>\n            `;\n            container.appendChild(row);\n        });\n    };\n\n    // 🔹 Inicializar filtros y gráficos\n    const initCharts = (data) => {\n        const filterBar = document.getElementById('filter-service-bar');\n        const filterPie = document.getElementById('filter-service-pie');\n\n        // Rellenar selects\n        const servicios = [...new Set(data.map(c => c.servicio))];\n        servicios.forEach(s => {\n            filterBar.innerHTML += `<option value=\"${s}\">${s}</option>`;\n            filterPie.innerHTML += `<option value=\"${s}\">${s}</option>`;\n        });\n\n        // Render inicial\n        renderBarChart(data);\n        renderPieChart(data);\n\n        // Listeners → cada gráfico escucha SOLO su filtro\n        filterBar.addEventListener('change', () => renderBarChart(data));\n        filterPie.addEventListener('change', () => renderPieChart(data));\n    };\n\n    // 🔹 Gráfico de barras (solo depende de filter-service-bar)\n    const renderBarChart = (data) => {\n        const filterValue = document.getElementById('filter-service-bar').value;\n\n        let filteredData = data;\n        if (filterValue !== 'ALL') {\n            filteredData = data.filter(c => c.servicio === filterValue);\n        }\n\n        // Agrupar por mes\n        const byMonth = {};\n        filteredData.forEach(c => {\n            const month = c.fecha.substring(0, 7); // yyyy-mm\n            byMonth[month] = (byMonth[month] || 0) + c.cantidad_tokens;\n        });\n\n        const ctx1 = document.getElementById('chart-tokens-by-month');\n        if (chartBar) chartBar.destroy();\n        chartBar = new Chart(ctx1, {\n            type: 'bar',\n            data: {\n                labels: Object.keys(byMonth),\n                datasets: [{\n                    label: 'Tokens consumidos',\n                    data: Object.values(byMonth),\n                    backgroundColor: '#0073e6'\n                }]\n            }\n        });\n    };\n\n    // 🔹 Gráfico de pie (solo depende de filter-service-pie)\n    const renderPieChart = (data) => {\n        const filterValue = document.getElementById('filter-service-pie').value;\n\n        let filteredData = data;\n        if (filterValue !== 'ALL') {\n            filteredData = data.filter(c => c.servicio === filterValue);\n        }\n\n        // Agrupar por acción\n        const byAction = {};\n        filteredData.forEach(c => {\n            byAction[c.accion] = (byAction[c.accion] || 0) + c.cantidad_tokens;\n        });\n\n        const ctx2 = document.getElementById('chart-actions');\n        if (chartPie) chartPie.destroy();\n        chartPie = new Chart(ctx2, {\n            type: 'pie',\n            data: {\n                labels: Object.keys(byAction),\n                datasets: [{\n                    data: Object.values(byAction),\n                    backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0']\n                }]\n            }\n        });\n    };\n};\n"],"names":["tokensAvailable","document","getElementById","tokensConsumed","tableBody","chartBar","chartPie","consumos","Promise","all","Ajax","call","methodname","args","then","async","historyResponse","saldoResponse","saldo","saldo_actual","textContent","reduce","sum","c","cantidad_tokens","renderTable","initCharts","catch","err","console","error","data","container","innerHTML","length","forEach","item","row","createElement","id_consumo","id_usuario","accion","servicio","saldo_restante","fecha","appendChild","nodata","filterBar","filterPie","Set","map","s","renderBarChart","renderPieChart","addEventListener","filterValue","value","filteredData","filter","byMonth","month","substring","ctx1","destroy","Chart","type","labels","Object","keys","datasets","label","values","backgroundColor","byAction","ctx2"],"mappings":";;;;;;;8KA6BoB,WAEVA,gBAAkBC,SAASC,eAAe,oBAC1CC,eAAiBF,SAASC,eAAe,mBACzCE,UAAYH,SAASC,eAAe,8BAGtCG,SAAUC,SADVC,SAAW,GAIfC,QAAQC,IAAI,CACRC,cAAKC,KAAK,CAAC,CAAEC,WAAY,+CAAgDC,KAAM,MAAO,GACtFH,cAAKC,KAAK,CAAC,CAAEC,WAAY,wCAAyCC,KAAM,MAAO,KAChFC,MAAKC,MAAAA,WAAQC,gBAAiBC,oBAC7BV,UAAWS,MAAAA,uBAAAA,gBAAiBT,WAAY,SAClCW,OAAQD,MAAAA,qBAAAA,cAAeE,eAAgB,EAG7CnB,gBAAgBoB,YAAcF,MAC9Bf,eAAeiB,YAAcb,SAASc,QAAO,CAACC,IAAKC,IAAMD,KAAOC,EAAEC,iBAAmB,IAAI,GAGzFC,YAAYlB,SAAUH,WAGtBsB,WAAWnB,aAEZoB,OAAMC,MACLC,QAAQC,MAAM,aAAcF,cAI1BH,YAAcV,MAAOgB,KAAMC,gBAC7BA,UAAUC,UAAY,GACjBF,KAAKG,OAKVH,KAAKI,SAAQC,aACHC,IAAMpC,SAASqC,cAAc,MACnCD,IAAIJ,0CACMG,KAAKG,iDACLH,KAAKI,iDACLJ,KAAKK,6CACLL,KAAKM,+CACLN,KAAKZ,sDACLY,KAAKO,qDACLP,KAAKQ,6BAEfZ,UAAUa,YAAYR,mBAfhBS,aAAe,mBAAU,SAAU,wBACzCd,UAAUC,4DAAuDa,uBAmBnEpB,WAAcK,aACVgB,UAAY9C,SAASC,eAAe,sBACpC8C,UAAY/C,SAASC,eAAe,sBAGxB,IAAI,IAAI+C,IAAIlB,KAAKmB,KAAI3B,GAAKA,EAAEmB,aACpCP,SAAQgB,IACdJ,UAAUd,oCAA+BkB,eAAMA,eAC/CH,UAAUf,oCAA+BkB,eAAMA,kBAInDC,eAAerB,MACfsB,eAAetB,MAGfgB,UAAUO,iBAAiB,UAAU,IAAMF,eAAerB,QAC1DiB,UAAUM,iBAAiB,UAAU,IAAMD,eAAetB,SAIxDqB,eAAkBrB,aACdwB,YAActD,SAASC,eAAe,sBAAsBsD,UAE9DC,aAAe1B,KACC,QAAhBwB,cACAE,aAAe1B,KAAK2B,QAAOnC,GAAKA,EAAEmB,WAAaa,qBAI7CI,QAAU,GAChBF,aAAatB,SAAQZ,UACXqC,MAAQrC,EAAEqB,MAAMiB,UAAU,EAAG,GACnCF,QAAQC,QAAUD,QAAQC,QAAU,GAAKrC,EAAEC,yBAGzCsC,KAAO7D,SAASC,eAAe,yBACjCG,UAAUA,SAAS0D,UACvB1D,SAAW,IAAI2D,iBAAMF,KAAM,CACvBG,KAAM,MACNlC,KAAM,CACFmC,OAAQC,OAAOC,KAAKT,SACpBU,SAAU,CAAC,CACPC,MAAO,oBACPvC,KAAMoC,OAAOI,OAAOZ,SACpBa,gBAAiB,gBAO3BnB,eAAkBtB,aACdwB,YAActD,SAASC,eAAe,sBAAsBsD,UAE9DC,aAAe1B,KACC,QAAhBwB,cACAE,aAAe1B,KAAK2B,QAAOnC,GAAKA,EAAEmB,WAAaa,qBAI7CkB,SAAW,GACjBhB,aAAatB,SAAQZ,IACjBkD,SAASlD,EAAEkB,SAAWgC,SAASlD,EAAEkB,SAAW,GAAKlB,EAAEC,yBAGjDkD,KAAOzE,SAASC,eAAe,iBACjCI,UAAUA,SAASyD,UACvBzD,SAAW,IAAI0D,iBAAMU,KAAM,CACvBT,KAAM,MACNlC,KAAM,CACFmC,OAAQC,OAAOC,KAAKK,UACpBJ,SAAU,CAAC,CACPtC,KAAMoC,OAAOI,OAAOE,UACpBD,gBAAiB,CAAC,UAAW,UAAW,UAAW"}