{"version":3,"file":"report_charts.min.js","sources":["../src/report_charts.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module report\n *\n * @module     aiprovider_datacurso/report_charts\n * @copyright  2025 Industria Elearning <info@industriaelearning.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable */\n\nimport Ajax from 'core/ajax';\nimport Chart from 'core/chartjs';\nimport {get_string as getString} from 'core/str';\n\nexport const init = () => {\n    console.log(\"📊 Report init\");\n\n    const tokensAvailable = document.getElementById('tokens-available');\n    const tokensConsumed = document.getElementById('tokens-consumed');\n    const tableBody = document.getElementById('consumption-table-body');\n\n    let consumos = [];\n    let chartBar, chartPie;\n\n    // 🔹 1. Llamadas a los WS\n    Promise.all([\n        Ajax.call([{ methodname: 'aiprovider_datacurso_get_consumption_history', args: {} }])[0],\n        Ajax.call([{ methodname: 'aiprovider_datacurso_get_tokens_saldo', args: {} }])[0],\n    ]).then(async ([historyResponse, saldoResponse]) => {\n        consumos = historyResponse?.consumos || [];\n        const saldo = saldoResponse?.saldo_actual || 0;\n\n        // 🔹 2. Actualizar cards\n        tokensAvailable.textContent = saldo;\n        tokensConsumed.textContent = consumos.reduce((sum, c) => sum + (c.cantidad_tokens || 0), 0);\n\n        // 🔹 3. Renderizar tabla\n        renderTable(consumos, tableBody);\n\n        // 🔹 4. Inicializar filtros y charts\n        initCharts(consumos);\n\n    }).catch(err => {\n        console.error(\"❌ Error WS\", err);\n    });\n\n    // 🔹 Tabla dinámica\n    const renderTable = async (data, container) => {\n        container.innerHTML = '';\n        if (!data.length) {\n            const nodata = await getString('nodata', 'aiprovider_datacurso');\n            container.innerHTML = `<tr><td colspan=\"7\" class=\"text-center\">${nodata}</td></tr>`;\n            return;\n        }\n        data.forEach(item => {\n            const row = document.createElement('tr');\n            row.innerHTML = `\n                <td>${item.id_consumo}</td>\n                <td>${item.id_usuario}</td>\n                <td>${item.accion}</td>\n                <td>${item.servicio}</td>\n                <td>${item.cantidad_tokens}</td>\n                <td>${item.saldo_restante}</td>\n                <td>${item.fecha}</td>\n            `;\n            container.appendChild(row);\n        });\n    };\n\n    // 🔹 Charts con filtros\n    const initCharts = (data) => {\n        const filterBar = document.getElementById('filter-service-bar');\n        const filterPie = document.getElementById('filter-service-pie');\n\n        // Rellenar selects\n        const servicios = [...new Set(data.map(c => c.servicio))];\n        servicios.forEach(s => {\n            filterBar.innerHTML += `<option value=\"${s}\">${s}</option>`;\n            filterPie.innerHTML += `<option value=\"${s}\">${s}</option>`;\n        });\n\n        // Inicial render\n        renderCharts(data);\n\n        // Listeners\n        filterBar.addEventListener('change', () => renderCharts(data));\n        filterPie.addEventListener('change', () => renderCharts(data));\n    };\n\n    const renderCharts = (data) => {\n        const filterBar = document.getElementById('filter-service-bar').value;\n        const filterPie = document.getElementById('filter-service-pie').value;\n\n        let filteredData = data;\n        if (filterBar !== 'ALL' || filterPie !== 'ALL') {\n            filteredData = data.filter(c =>\n                (filterBar === 'ALL' || c.servicio === filterBar) &&\n                (filterPie === 'ALL' || c.servicio === filterPie)\n            );\n        }\n\n        // Agrupar por mes\n        const byMonth = {};\n        filteredData.forEach(c => {\n            const month = c.fecha.substring(0, 7); // yyyy-mm\n            byMonth[month] = (byMonth[month] || 0) + c.cantidad_tokens;\n        });\n\n        // Agrupar por acción\n        const byAction = {};\n        filteredData.forEach(c => {\n            byAction[c.accion] = (byAction[c.accion] || 0) + c.cantidad_tokens;\n        });\n\n        // Chart bar\n        const ctx1 = document.getElementById('chart-tokens-by-month');\n        if (chartBar) chartBar.destroy();\n        chartBar = new Chart(ctx1, {\n            type: 'bar',\n            data: {\n                labels: Object.keys(byMonth),\n                datasets: [{\n                    label: 'Tokens consumidos',\n                    data: Object.values(byMonth),\n                    backgroundColor: '#0073e6'\n                }]\n            }\n        });\n\n        // Chart pie\n        const ctx2 = document.getElementById('chart-actions');\n        if (chartPie) chartPie.destroy();\n        chartPie = new Chart(ctx2, {\n            type: 'pie',\n            data: {\n                labels: Object.keys(byAction),\n                datasets: [{\n                    data: Object.values(byAction),\n                    backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0']\n                }]\n            }\n        });\n    };\n};\n"],"names":["console","log","tokensAvailable","document","getElementById","tokensConsumed","tableBody","chartBar","chartPie","consumos","Promise","all","Ajax","call","methodname","args","then","async","historyResponse","saldoResponse","saldo","saldo_actual","textContent","reduce","sum","c","cantidad_tokens","renderTable","initCharts","catch","err","error","data","container","innerHTML","length","forEach","item","row","createElement","id_consumo","id_usuario","accion","servicio","saldo_restante","fecha","appendChild","nodata","filterBar","filterPie","Set","map","s","renderCharts","addEventListener","value","filteredData","filter","byMonth","month","substring","byAction","ctx1","destroy","Chart","type","labels","Object","keys","datasets","label","values","backgroundColor","ctx2"],"mappings":";;;;;;;8KA6BoB,KAChBA,QAAQC,IAAI,wBAENC,gBAAkBC,SAASC,eAAe,oBAC1CC,eAAiBF,SAASC,eAAe,mBACzCE,UAAYH,SAASC,eAAe,8BAGtCG,SAAUC,SADVC,SAAW,GAIfC,QAAQC,IAAI,CACRC,cAAKC,KAAK,CAAC,CAAEC,WAAY,+CAAgDC,KAAM,MAAO,GACtFH,cAAKC,KAAK,CAAC,CAAEC,WAAY,wCAAyCC,KAAM,MAAO,KAChFC,MAAKC,MAAAA,WAAQC,gBAAiBC,oBAC7BV,UAAWS,MAAAA,uBAAAA,gBAAiBT,WAAY,SAClCW,OAAQD,MAAAA,qBAAAA,cAAeE,eAAgB,EAG7CnB,gBAAgBoB,YAAcF,MAC9Bf,eAAeiB,YAAcb,SAASc,QAAO,CAACC,IAAKC,IAAMD,KAAOC,EAAEC,iBAAmB,IAAI,GAGzFC,YAAYlB,SAAUH,WAGtBsB,WAAWnB,aAEZoB,OAAMC,MACL9B,QAAQ+B,MAAM,aAAcD,cAI1BH,YAAcV,MAAOe,KAAMC,gBAC7BA,UAAUC,UAAY,GACjBF,KAAKG,OAKVH,KAAKI,SAAQC,aACHC,IAAMnC,SAASoC,cAAc,MACnCD,IAAIJ,0CACMG,KAAKG,iDACLH,KAAKI,iDACLJ,KAAKK,6CACLL,KAAKM,+CACLN,KAAKX,sDACLW,KAAKO,qDACLP,KAAKQ,6BAEfZ,UAAUa,YAAYR,mBAfhBS,aAAe,mBAAU,SAAU,wBACzCd,UAAUC,4DAAuDa,uBAmBnEnB,WAAcI,aACVgB,UAAY7C,SAASC,eAAe,sBACpC6C,UAAY9C,SAASC,eAAe,sBAGxB,IAAI,IAAI8C,IAAIlB,KAAKmB,KAAI1B,GAAKA,EAAEkB,aACpCP,SAAQgB,IACdJ,UAAUd,oCAA+BkB,eAAMA,eAC/CH,UAAUf,oCAA+BkB,eAAMA,kBAInDC,aAAarB,MAGbgB,UAAUM,iBAAiB,UAAU,IAAMD,aAAarB,QACxDiB,UAAUK,iBAAiB,UAAU,IAAMD,aAAarB,SAGtDqB,aAAgBrB,aACZgB,UAAY7C,SAASC,eAAe,sBAAsBmD,MAC1DN,UAAY9C,SAASC,eAAe,sBAAsBmD,UAE5DC,aAAexB,KACD,QAAdgB,WAAqC,QAAdC,YACvBO,aAAexB,KAAKyB,QAAOhC,KACR,QAAduB,WAAuBvB,EAAEkB,WAAaK,WACxB,QAAdC,WAAuBxB,EAAEkB,WAAaM,oBAKzCS,QAAU,GAChBF,aAAapB,SAAQX,UACXkC,MAAQlC,EAAEoB,MAAMe,UAAU,EAAG,GACnCF,QAAQC,QAAUD,QAAQC,QAAU,GAAKlC,EAAEC,yBAIzCmC,SAAW,GACjBL,aAAapB,SAAQX,IACjBoC,SAASpC,EAAEiB,SAAWmB,SAASpC,EAAEiB,SAAW,GAAKjB,EAAEC,yBAIjDoC,KAAO3D,SAASC,eAAe,yBACjCG,UAAUA,SAASwD,UACvBxD,SAAW,IAAIyD,iBAAMF,KAAM,CACvBG,KAAM,MACNjC,KAAM,CACFkC,OAAQC,OAAOC,KAAKV,SACpBW,SAAU,CAAC,CACPC,MAAO,oBACPtC,KAAMmC,OAAOI,OAAOb,SACpBc,gBAAiB,qBAMvBC,KAAOtE,SAASC,eAAe,iBACjCI,UAAUA,SAASuD,UACvBvD,SAAW,IAAIwD,iBAAMS,KAAM,CACvBR,KAAM,MACNjC,KAAM,CACFkC,OAAQC,OAAOC,KAAKP,UACpBQ,SAAU,CAAC,CACPrC,KAAMmC,OAAOI,OAAOV,UACpBW,gBAAiB,CAAC,UAAW,UAAW,UAAW"}