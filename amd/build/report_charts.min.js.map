{"version":3,"file":"report_charts.min.js","sources":["../src/report_charts.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Report charts module.\n *\n * @module     aiprovider_datacurso/report_charts\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable */\n\nimport Ajax from 'core/ajax';\nimport Chart from 'core/chartjs';\nimport { get_string as getString } from 'core/str';\n\nexport const init = () => {\n\n    const tokensAvailable = document.getElementById('tokens-available');\n    const tokensConsumed = document.getElementById('tokens-consumed');\n    const tableBody = document.getElementById('consumption-table-body');\n\n    let consumos = [];\n    let chartBar, chartPie;\n\n    // 🔹 1. WS calls\n    Promise.all([\n        Ajax.call([{ methodname: 'aiprovider_datacurso_get_consumption_history', args: {} }])[0],\n        Ajax.call([{ methodname: 'aiprovider_datacurso_get_tokens_saldo', args: {} }])[0],\n    ]).then(async ([historyResponse, saldoResponse]) => {\n        consumos = historyResponse?.consumos || [];\n        const saldo = saldoResponse?.saldo_actual || 0;\n\n        // 🔹 2. Update cards\n        tokensAvailable.textContent = saldo;\n        tokensConsumed.textContent = consumos.reduce((sum, c) => sum + (c.cantidad_tokens || 0), 0);\n\n        // 🔹 3. Render table\n        renderTable(consumos, tableBody);\n\n        // 🔹 4. Initialize filters and charts\n        initCharts(consumos);\n\n    }).catch(err => {\n        console.error(\"❌ WS Error\", err);\n    });\n\n    // 🔹 Dynamic table\n    const renderTable = async (data, container) => {\n        container.innerHTML = '';\n        if (!data.length) {\n            const nodata = await getString('nodata', 'aiprovider_datacurso');\n            container.innerHTML = `<tr><td colspan=\"7\" class=\"text-center\">${nodata}</td></tr>`;\n            return;\n        }\n        data.forEach(item => {\n            const row = document.createElement('tr');\n            row.innerHTML = `\n                <td>${item.id_consumo}</td>\n                <td>${item.id_usuario}</td>\n                <td>${item.accion}</td>\n                <td>${item.servicio}</td>\n                <td>${item.cantidad_tokens}</td>\n                <td>${item.saldo_restante}</td>\n                <td>${item.fecha}</td>\n            `;\n            container.appendChild(row);\n        });\n    };\n\n    // 🔹 Initialize filters and charts\n    const initCharts = (data) => {\n        const filterBar = document.getElementById('filter-service-bar');\n        const filterPie = document.getElementById('filter-service-pie');\n\n        // Fill selects\n        const servicios = [...new Set(data.map(c => c.servicio))];\n        servicios.forEach(s => {\n            filterBar.innerHTML += `<option value=\"${s}\">${s}</option>`;\n            filterPie.innerHTML += `<option value=\"${s}\">${s}</option>`;\n        });\n\n        // Initial render\n        renderBarChart(data);\n        renderPieChart(data);\n        renderDayChart(data);\n\n        // Listeners → each chart listens ONLY to its filter\n        filterBar.addEventListener('change', () => renderBarChart(data));\n        filterPie.addEventListener('change', () => renderPieChart(data));\n\n        // Date filters for daily chart\n        document.getElementById('filter-start-date').addEventListener('change', () => renderDayChart(data));\n        document.getElementById('filter-end-date').addEventListener('change', () => renderDayChart(data));\n    };\n\n    // 🔹 Bar chart (depends only on filter-service-bar)\n    const renderBarChart = (data) => {\n        const filterValue = document.getElementById('filter-service-bar').value;\n\n        let filteredData = data;\n        if (filterValue !== 'ALL') {\n            filteredData = data.filter(c => c.servicio === filterValue);\n        }\n\n        // Group by month\n        const byMonth = {};\n        filteredData.forEach(c => {\n            const month = c.fecha.substring(0, 7); // yyyy-mm\n            byMonth[month] = (byMonth[month] || 0) + c.cantidad_tokens;\n        });\n\n        const ctx1 = document.getElementById('chart-tokens-by-month');\n        if (chartBar) chartBar.destroy();\n        chartBar = new Chart(ctx1, {\n            type: 'bar',\n            data: {\n                labels: Object.keys(byMonth),\n                datasets: [{\n                    label: 'Tokens consumed',\n                    data: Object.values(byMonth),\n                    backgroundColor: '#0073e6'\n                }]\n            }\n        });\n    };\n\n    // 🔹 Pie chart (depends only on filter-service-pie)\n    const renderPieChart = (data) => {\n        const filterValue = document.getElementById('filter-service-pie').value;\n\n        let filteredData = data;\n        if (filterValue !== 'ALL') {\n            filteredData = data.filter(c => c.servicio === filterValue);\n        }\n\n        // Group by action\n        const byAction = {};\n        filteredData.forEach(c => {\n            byAction[c.accion] = (byAction[c.accion] || 0) + c.cantidad_tokens;\n        });\n\n        const ctx2 = document.getElementById('chart-actions');\n        if (chartPie) chartPie.destroy();\n        chartPie = new Chart(ctx2, {\n            type: 'pie',\n            data: {\n                labels: Object.keys(byAction),\n                datasets: [{\n                    data: Object.values(byAction),\n                    backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0']\n                }]\n            }\n        });\n    };\n\n    let chartDay;\n\n    // 🔹 Daily consumption chart with date filters\n    const renderDayChart = (data) => {\n        const startDate = document.getElementById('filter-start-date').value;\n        const endDate = document.getElementById('filter-end-date').value;\n\n        let filteredData = data;\n\n        // Filter by date range\n        if (startDate) {\n            filteredData = filteredData.filter(c => c.fecha >= startDate);\n        }\n        if (endDate) {\n            filteredData = filteredData.filter(c => c.fecha <= endDate);\n        }\n\n        // Group by day\n        const byDay = {};\n        filteredData.forEach(c => {\n            const day = c.fecha.substring(0, 10); // yyyy-mm-dd\n            byDay[day] = (byDay[day] || 0) + c.cantidad_tokens;\n        });\n\n        const ctx3 = document.getElementById('chart-tokens-by-day');\n        if (chartDay) chartDay.destroy();\n        chartDay = new Chart(ctx3, {\n            type: 'line',\n            data: {\n                labels: Object.keys(byDay),\n                datasets: [{\n                    label: 'Tokens consumed per day',\n                    data: Object.values(byDay),\n                    borderColor: '#28a745',\n                    backgroundColor: 'rgba(40,167,69,0.2)',\n                    fill: true,\n                }]\n            }\n        });\n    };\n};\n"],"names":["tokensAvailable","document","getElementById","tokensConsumed","tableBody","chartBar","chartPie","consumos","Promise","all","Ajax","call","methodname","args","then","async","historyResponse","saldoResponse","saldo","saldo_actual","textContent","reduce","sum","c","cantidad_tokens","renderTable","initCharts","catch","err","console","error","data","container","innerHTML","length","forEach","item","row","createElement","id_consumo","id_usuario","accion","servicio","saldo_restante","fecha","appendChild","nodata","filterBar","filterPie","Set","map","s","renderBarChart","renderPieChart","renderDayChart","addEventListener","filterValue","value","filteredData","filter","byMonth","month","substring","ctx1","destroy","Chart","type","labels","Object","keys","datasets","label","values","backgroundColor","byAction","ctx2","chartDay","startDate","endDate","byDay","day","ctx3","borderColor","fill"],"mappings":"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"}