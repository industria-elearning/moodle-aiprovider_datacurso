define("aiprovider_datacurso/report_charts",["exports","core/ajax","core/chartjs","core/str"],(function(_exports,_ajax,_chartjs,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Report charts module.
   *
   * @module     aiprovider_datacurso/report_charts
   * @copyright  2025 Industria Elearning
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_chartjs=_interopRequireDefault(_chartjs);_exports.init=()=>{const tokensAvailable=document.getElementById("tokens-available"),tokensConsumed=document.getElementById("tokens-consumed"),tableBody=document.getElementById("consumption-table-body");let chartBar,chartPie,consumos=[];Promise.all([_ajax.default.call([{methodname:"aiprovider_datacurso_get_consumption_history",args:{}}])[0],_ajax.default.call([{methodname:"aiprovider_datacurso_get_tokens_saldo",args:{}}])[0]]).then((async _ref=>{let[historyResponse,saldoResponse]=_ref;consumos=(null==historyResponse?void 0:historyResponse.consumos)||[];const saldo=(null==saldoResponse?void 0:saldoResponse.saldo_actual)||0;tokensAvailable.textContent=saldo,tokensConsumed.textContent=consumos.reduce(((sum,c)=>sum+(c.cantidad_tokens||0)),0),renderTable(consumos,tableBody),initCharts(consumos)})).catch((err=>{console.error("❌ WS Error",err)}));const renderTable=async(data,container)=>{if(container.innerHTML="",data.length)data.forEach((item=>{const row=document.createElement("tr");row.innerHTML="\n                <td>".concat(item.id_consumo,"</td>\n                <td>").concat(item.id_usuario,"</td>\n                <td>").concat(item.accion,"</td>\n                <td>").concat(item.servicio,"</td>\n                <td>").concat(item.cantidad_tokens,"</td>\n                <td>").concat(item.saldo_restante,"</td>\n                <td>").concat(item.fecha,"</td>\n            "),container.appendChild(row)}));else{const nodata=await(0,_str.get_string)("nodata","aiprovider_datacurso");container.innerHTML='<tr><td colspan="7" class="text-center">'.concat(nodata,"</td></tr>")}},initCharts=data=>{const filterBar=document.getElementById("filter-service-bar"),filterPie=document.getElementById("filter-service-pie");[...new Set(data.map((c=>c.servicio)))].forEach((s=>{filterBar.innerHTML+='<option value="'.concat(s,'">').concat(s,"</option>"),filterPie.innerHTML+='<option value="'.concat(s,'">').concat(s,"</option>")})),renderBarChart(data),renderPieChart(data),renderDayChart(data),filterBar.addEventListener("change",(()=>renderBarChart(data))),filterPie.addEventListener("change",(()=>renderPieChart(data))),document.getElementById("filter-start-date").addEventListener("change",(()=>renderDayChart(data))),document.getElementById("filter-end-date").addEventListener("change",(()=>renderDayChart(data)))},renderBarChart=data=>{const filterValue=document.getElementById("filter-service-bar").value;let filteredData=data;"ALL"!==filterValue&&(filteredData=data.filter((c=>c.servicio===filterValue)));const byMonth={};filteredData.forEach((c=>{const month=c.fecha.substring(0,7);byMonth[month]=(byMonth[month]||0)+c.cantidad_tokens}));const ctx1=document.getElementById("chart-tokens-by-month");chartBar&&chartBar.destroy(),chartBar=new _chartjs.default(ctx1,{type:"bar",data:{labels:Object.keys(byMonth),datasets:[{label:"Tokens consumed",data:Object.values(byMonth),backgroundColor:"#0073e6"}]}})},renderPieChart=data=>{const filterValue=document.getElementById("filter-service-pie").value;let filteredData=data;"ALL"!==filterValue&&(filteredData=data.filter((c=>c.servicio===filterValue)));const byAction={};filteredData.forEach((c=>{byAction[c.accion]=(byAction[c.accion]||0)+c.cantidad_tokens}));const ctx2=document.getElementById("chart-actions");chartPie&&chartPie.destroy(),chartPie=new _chartjs.default(ctx2,{type:"pie",data:{labels:Object.keys(byAction),datasets:[{data:Object.values(byAction),backgroundColor:["#36A2EB","#FF6384","#FFCE56","#4BC0C0"]}]}})};let chartDay;const renderDayChart=data=>{const startDate=document.getElementById("filter-start-date").value,endDate=document.getElementById("filter-end-date").value;let filteredData=data;startDate&&(filteredData=filteredData.filter((c=>c.fecha>=startDate))),endDate&&(filteredData=filteredData.filter((c=>c.fecha<=endDate)));const byDay={};filteredData.forEach((c=>{const day=c.fecha.substring(0,10);byDay[day]=(byDay[day]||0)+c.cantidad_tokens}));const ctx3=document.getElementById("chart-tokens-by-day");chartDay&&chartDay.destroy(),chartDay=new _chartjs.default(ctx3,{type:"line",data:{labels:Object.keys(byDay),datasets:[{label:"Tokens consumed per day",data:Object.values(byDay),borderColor:"#28a745",backgroundColor:"rgba(40,167,69,0.2)",fill:!0}]}})}}}));

//# sourceMappingURL=report_charts.min.js.map